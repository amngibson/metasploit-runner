require 'msfrpc-client'
require 'metasploit/constants'

module Metasploit
  module Exploit
    def Exploit.start(connection_url, port, uri, use_ssl, token, workspace_name, nexpose_console_name, device_ip_to_scan)
      are_parameters_valid(connection_url, token, workspace_name, device_ip_to_scan)

      rpc_client = get_new_metasploit_rpc_connection(connection_url, port, uri, use_ssl, token)

      create_workspace(rpc_client, workspace_name)

      do_nexpose_import(nexpose_console_name, rpc_client, workspace_name)

      do_metasploit_scan(device_ip_to_scan, rpc_client, workspace_name)
    end

    private
    def self.are_parameters_valid(connection_url, token, workspace_name, device_ip_to_scan)
      raise StandardError, CONSTANTS::REQUIRED_WORKSPACE_MESSAGE if workspace_name.nil? || workspace_name.empty?
      raise StandardError, CONSTANTS::REQUIRED_TOKEN_MESSAGE if token.nil? || token.empty?
      raise StandardError, CONSTANTS::REQUIRED_CONNECTION_URL_MESSAGE if connection_url.nil? || connection_url.empty?
      raise StandardError, CONSTANTS::REQUIRED_DEVICE_IP_TO_SCAN_MESSAGE if device_ip_to_scan.nil? || device_ip_to_scan.empty?
    end

    def self.get_metasploit_options(connection_url, port, uri, use_ssl, token)
      if port.nil? || port.empty?
        puts CONSTANTS::USING_DEFAULT_PORT_MESSAGE
        port = CONSTANTS::DEFAULT_PORT
      end

      if uri.nil? || uri.empty?
        puts CONSTANTS::USING_DEFAULT_URI_MESSAGE
        uri = CONSTANTS::DEFAULT_URI
      end

      if use_ssl != false
        puts CONSTANTS::USING_DEFAULT_SSL_MESSAGE
        use_ssl = CONSTANTS::DEFAULT_SSL
      end

      {:host => connection_url, :port => port, :token => token, :uri => uri, :ssl => use_ssl}
    end

    def self.get_new_metasploit_rpc_connection(connection_url, port, uri, use_ssl, token)
      client = Msf::RPC::Client.new(get_metasploit_options(connection_url, port, uri, use_ssl, token))
      puts CONSTANTS::SUCCESSFUL_CONNECTION_MESSAGE

      client
    end

    def self.do_nexpose_import(nexpose_console_name, rpc_client, workspace_name)
      import = rpc_client.call('pro.start_import', {'workspace' => workspace_name, 'DS_NEXPOSE_CONSOLE' => nexpose_console_name, 'DS_NEXPOSE_SITE' => workspace_name})

      wait_for_task_to_stop_running(rpc_client, CONSTANTS::IMPORTING_DATA_MESSAGE, import['task_id'])
    end
    
    def self.create_workspace(rpc_client, workspace_name)
      rpc_client.call('pro.workspace_add', {'name' => workspace_name})
    end

    def self.do_metasploit_scan(device_ip_to_scan, rpc_client, workspace_name)
      scan = rpc_client.call('pro.start_webscan', {'workspace' => workspace_name, 'DS_URLS' => "http://#{device_ip_to_scan}"})

      wait_for_task_to_stop_running(rpc_client, CONSTANTS::SCANNING_MESSAGE, scan['task_id'])
    end

    def self.wait_for_task_to_stop_running(rpc_client, status_message, task_id)
      sleep(3)
      status = rpc_client.call('pro.task_status', task_id)
      puts status_message

      wait_for_task_to_stop_running(rpc_client, status_message, task_id) if status['status'] == CONSTANTS::RUNNING_IMPORT_STATUS
    end
  end
end